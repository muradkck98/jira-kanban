generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Users ────────────────────────────────────────────────────────────────────
model User {
  id           String    @id @default(uuid()) @db.Uuid
  username     String    @unique @db.VarChar(100)
  email        String?   @db.VarChar(255)
  fullName     String    @map("full_name") @db.VarChar(255)
  displayName  String    @map("display_name") @db.VarChar(255)
  passwordHash String?   @map("password_hash")
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  department   String?   @db.VarChar(255)
  authProvider String    @default("local") @map("auth_provider") @db.VarChar(20)
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  ldapSyncedAt DateTime? @map("ldap_synced_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  ownedProjects     Project[]         @relation("ProjectOwner")
  projectMembers    ProjectMember[]
  reportedIssues    Issue[]           @relation("IssueReporter")
  assignedIssues    Issue[]           @relation("IssueAssignee")
  comments          Comment[]
  attachments       Attachment[]
  activities        Activity[]
  submittedForms    FormSubmission[]  @relation("FormSubmitter")
  reviewedForms     FormSubmission[]  @relation("FormReviewer")
  pages             Page[]

  @@map("users")
}

// ─── Projects ─────────────────────────────────────────────────────────────────
model Project {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  key          String   @unique @db.VarChar(10)
  description  String?  @db.Text
  ownerId      String   @map("owner_id") @db.Uuid
  owner        User     @relation("ProjectOwner", fields: [ownerId], references: [id])
  issueCounter Int      @default(0) @map("issue_counter")
  isArchived   Boolean  @default(false) @map("is_archived")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  members         ProjectMember[]
  boards          Board[]
  issues          Issue[]
  labels          Label[]
  sprints         Sprint[]
  epics           Epic[]
  issueTypes      IssueType[]
  formSubmissions FormSubmission[]
  pages           Page[]

  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  role      String   @default("member") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([projectId, userId])
  @@map("project_members")
}

// ─── Boards & Columns ─────────────────────────────────────────────────────────
model Board {
  id               String   @id @default(uuid()) @db.Uuid
  projectId        String   @map("project_id") @db.Uuid
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name             String   @db.VarChar(255)
  description      String?  @db.Text
  analyticsEnabled Boolean  @default(false) @map("analytics_enabled")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  columns Column[]
  issues  Issue[]

  @@map("boards")
}

model Column {
  id        String   @id @default(uuid()) @db.Uuid
  boardId   String   @map("board_id") @db.Uuid
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(255)
  category  String   @default("todo") @db.VarChar(20)
  position  Int      @default(0)
  wipLimit  Int      @default(0) @map("wip_limit")
  color     String?  @db.VarChar(7)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  issues Issue[]

  @@map("columns")
}

// ─── Issue Types ──────────────────────────────────────────────────────────────
model IssueType {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(100)
  icon      String?  @db.VarChar(10)
  color     String?  @db.VarChar(7)
  createdAt DateTime @default(now()) @map("created_at")

  issues Issue[]

  @@map("issue_types")
}

// ─── Sprints ──────────────────────────────────────────────────────────────────
model Sprint {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String    @db.VarChar(255)
  goal        String?   @db.Text
  status      String    @default("planning") @db.VarChar(20)
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  issues Issue[]

  @@map("sprints")
}

// ─── Epics ────────────────────────────────────────────────────────────────────
model Epic {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String    @db.VarChar(255)
  description String?   @db.Text
  status      String    @default("open") @db.VarChar(20)
  color       String?   @db.VarChar(7)
  startDate   DateTime? @map("start_date")
  targetDate  DateTime? @map("target_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  issues Issue[]

  @@map("epics")
}

// ─── Labels ───────────────────────────────────────────────────────────────────
model Label {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(100)
  color     String   @default("#1890ff") @db.VarChar(7)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  issues Issue[] @relation("IssueLabels")

  @@map("labels")
}

// ─── Issues ───────────────────────────────────────────────────────────────────
model Issue {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  boardId     String?   @map("board_id") @db.Uuid
  board       Board?    @relation(fields: [boardId], references: [id])
  columnId    String    @map("column_id") @db.Uuid
  column      Column    @relation(fields: [columnId], references: [id])
  sprintId    String?   @map("sprint_id") @db.Uuid
  sprint      Sprint?   @relation(fields: [sprintId], references: [id])
  epicId      String?   @map("epic_id") @db.Uuid
  epic        Epic?     @relation(fields: [epicId], references: [id])
  parentId    String?   @map("parent_id") @db.Uuid
  parent      Issue?    @relation("Subtasks", fields: [parentId], references: [id])
  subtasks    Issue[]   @relation("Subtasks")
  issueTypeId String?   @map("issue_type_id") @db.Uuid
  issueType   IssueType? @relation(fields: [issueTypeId], references: [id])
  issueNumber Int       @map("issue_number")
  issueKey    String    @map("issue_key") @db.VarChar(20)
  title       String    @db.VarChar(500)
  description String?   @db.Text
  priority    String    @default("medium") @db.VarChar(20)
  storyPoints Int?      @map("story_points")
  position    Int       @default(0)
  dueDate     DateTime? @map("due_date")
  reporterId  String    @map("reporter_id") @db.Uuid
  reporter    User      @relation("IssueReporter", fields: [reporterId], references: [id])
  assigneeId  String?   @map("assignee_id") @db.Uuid
  assignee    User?     @relation("IssueAssignee", fields: [assigneeId], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  labels      Label[]      @relation("IssueLabels")
  comments    Comment[]
  attachments Attachment[]
  activities  Activity[]

  @@index([projectId])
  @@index([columnId])
  @@index([sprintId])
  @@index([assigneeId])
  @@map("issues")
}

// ─── Comments ─────────────────────────────────────────────────────────────────
model Comment {
  id        String    @id @default(uuid()) @db.Uuid
  issueId   String    @map("issue_id") @db.Uuid
  issue     Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id])
  content   String    @db.Text
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("comments")
}

// ─── Attachments ──────────────────────────────────────────────────────────────
model Attachment {
  id        String    @id @default(uuid()) @db.Uuid
  issueId   String    @map("issue_id") @db.Uuid
  issue     Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String    @map("user_id") @db.Uuid
  user      User      @relation(fields: [userId], references: [id])
  filename  String    @db.VarChar(500)
  filePath  String    @map("file_path") @db.VarChar(1000)
  fileSize  BigInt    @map("file_size")
  mimeType  String?   @map("mime_type") @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("attachments")
}

// ─── Activities ───────────────────────────────────────────────────────────────
model Activity {
  id        String   @id @default(uuid()) @db.Uuid
  issueId   String   @map("issue_id") @db.Uuid
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  action    String   @db.VarChar(50)
  oldValue  String?  @map("old_value") @db.Text
  newValue  String?  @map("new_value") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@map("activities")
}

// ─── Form Submissions (NEW) ───────────────────────────────────────────────────
model FormSubmission {
  id             String    @id @default(uuid()) @db.Uuid
  projectId      String    @map("project_id") @db.Uuid
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  submittedById  String    @map("submitted_by_id") @db.Uuid
  submittedBy    User      @relation("FormSubmitter", fields: [submittedById], references: [id])
  reviewedById   String?   @map("reviewed_by_id") @db.Uuid
  reviewedBy     User?     @relation("FormReviewer", fields: [reviewedById], references: [id])
  issueTypeKey   String    @map("issue_type_key") @db.VarChar(50)
  title          String    @db.VarChar(500)
  description    String    @db.Text
  priority       String    @default("medium") @db.VarChar(20)
  assigneeId     String?   @map("assignee_id") @db.Uuid
  status         String    @default("pending") @db.VarChar(20)
  reviewNote     String?   @map("review_note") @db.Text
  createdIssueId String?   @map("created_issue_id") @db.Uuid
  reviewedAt     DateTime? @map("reviewed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([projectId, status])
  @@map("form_submissions")
}

// ─── Pages (Confluence-style) (NEW) ───────────────────────────────────────────
model Page {
  id         String    @id @default(uuid()) @db.Uuid
  projectId  String    @map("project_id") @db.Uuid
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorId   String    @map("author_id") @db.Uuid
  author     User      @relation(fields: [authorId], references: [id])
  title      String    @db.VarChar(500)
  content    String    @db.Text
  emoji      String?   @db.VarChar(10)
  isStarred  Boolean   @default(false) @map("is_starred")
  shareToken String?   @unique @map("share_token") @db.VarChar(64)
  tags       String[]
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  @@index([projectId])
  @@map("pages")
}
